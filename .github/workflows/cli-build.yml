name: CLI Build and Release

on:
  push:
    branches: [ main, master, dev ]
    tags: [ 'v*', 'cli-v*' ]
    paths:
      - 'EarthTool.CLI/**'
      - 'EarthTool.Common/**'
      - 'EarthTool.WD/**'
      - 'EarthTool.MSH/**'
      - 'EarthTool.DAE/**'
      - 'EarthTool.PAR/**'
      - 'EarthTool.TEX/**'
      - '.github/workflows/cli-build.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'EarthTool.CLI/**'
      - 'EarthTool.Common/**'
      - 'EarthTool.WD/**'
      - 'EarthTool.MSH/**'
      - 'EarthTool.DAE/**'
      - 'EarthTool.PAR/**'
      - 'EarthTool.TEX/**'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'EarthTool.CLI/EarthTool.CLI.csproj'
  SOLUTION_FILE: 'EarthTool.sln'

jobs:
  build-and-test:
    name: Build CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        include:
          - os: windows-latest
            runtime: win-x64
            artifact_name: EarthTool.CLI-Windows-x64
            executable: EarthTool.CLI.exe
          - os: ubuntu-latest
            runtime: linux-x64
            artifact_name: EarthTool.CLI-Linux-x64
            executable: EarthTool.CLI
          - os: macos-latest
            runtime: osx-x64
            artifact_name: EarthTool.CLI-macOS-x64
            executable: EarthTool.CLI

    steps:
    - name: Display build context
      shell: bash
      run: |
        echo "ðŸš€ Building EarthTool.CLI"
        echo "Platform: ${{ matrix.os }}"
        echo "Runtime: ${{ matrix.runtime }}"
        echo "Event: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore

    - name: Run tests
      run: dotnet test ${{ env.SOLUTION_FILE }} --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results-${{ matrix.runtime }}.trx"
      continue-on-error: false

    - name: Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Test Results (${{ matrix.os }})
        path: '**/*.trx'
        reporter: dotnet-trx
        fail-on-error: false

    - name: Publish CLI application
      shell: bash
      run: |
        dotnet publish ${{ env.PROJECT_PATH }} \
          --configuration Release \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish/${{ matrix.runtime }} \
          -p:PublishSingleFile=true \
          -p:IncludeNativeLibrariesForSelfExtract=true \
          -p:EnableCompressionInSingleFile=true \
          -p:DebugType=none \
          -p:DebugSymbols=false

    - name: Create artifact archive
      shell: bash
      run: |
        cd "publish/${{ matrix.runtime }}"
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          7z a -tzip "../../${{ matrix.artifact_name }}.zip" *
        else
          tar -czf "../../${{ matrix.artifact_name }}.tar.gz" *
        fi
        cd ../..

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}${{ matrix.os == 'windows-latest' && '.zip' || '.tar.gz' }}
        retention-days: 30

    - name: Upload executable for release
      uses: actions/upload-artifact@v4
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: ${{ matrix.artifact_name }}-executable
        path: publish/${{ matrix.runtime }}/${{ matrix.executable }}
        retention-days: 90

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ubuntu-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ubuntu-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Install dotnet format
      run: dotnet tool install -g dotnet-format || dotnet tool update -g dotnet-format

    - name: Check code formatting
      run: dotnet format ${{ env.SOLUTION_FILE }} --verify-no-changes --verbosity diagnostic
      continue-on-error: true

    - name: Run code analysis with warnings
      run: |
        dotnet build ${{ env.SOLUTION_FILE }} \
          --configuration Release \
          --no-restore \
          /p:TreatWarningsAsErrors=false \
          /p:WarningLevel=4

  create-release:
    name: Create Release
    needs: [build-and-test, code-quality]
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Generate changelog
      id: changelog
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "push" ] && [ "${{ startsWith(github.ref, 'refs/tags/') }}" = "true" ]; then
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "## Changes since $PREV_TAG" > CHANGELOG.md
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md
          else
            echo "## Initial Release" > CHANGELOG.md
          fi
        else
          echo "## Manual Release" > CHANGELOG.md
          echo "Created manually via workflow dispatch" >> CHANGELOG.md
        fi
        
        cat CHANGELOG.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: EarthTool CLI ${{ github.ref_name }}
        body_path: CHANGELOG.md
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        files: |
          artifacts/EarthTool.CLI-Windows-x64/EarthTool.CLI-Windows-x64.zip
          artifacts/EarthTool.CLI-Linux-x64/EarthTool.CLI-Linux-x64.tar.gz
          artifacts/EarthTool.CLI-macOS-x64/EarthTool.CLI-macOS-x64.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
