name: Libraries CI

on:
  push:
    branches: [ main, master, dev ]
    paths:
      - 'EarthTool.WD/**'
      - 'EarthTool.MSH/**'
      - 'EarthTool.DAE/**'
      - 'EarthTool.PAR/**'
      - 'EarthTool.TEX/**'
      - 'EarthTool.Common/**'
      - '**/*.Tests/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'EarthTool.WD/**'
      - 'EarthTool.MSH/**'
      - 'EarthTool.DAE/**'
      - 'EarthTool.PAR/**'
      - 'EarthTool.TEX/**'
      - 'EarthTool.Common/**'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  test-libraries:
    name: Test ${{ matrix.library }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        library:
          - name: WD
            project: EarthTool.WD
            test: EarthTool.WD.Tests
          - name: MSH
            project: EarthTool.MSH
            test: EarthTool.MSH.Tests
          - name: DAE
            project: EarthTool.DAE
            test: EarthTool.DAE.Tests
          - name: PAR
            project: EarthTool.PAR
            test: EarthTool.PAR.Tests
          - name: TEX
            project: EarthTool.TEX
            test: EarthTool.TEX.Tests
          - name: Common
            project: EarthTool.Common
            test: ""
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET Environment
      uses: ./.github/actions/setup-dotnet-env

    - name: Restore dependencies
      run: dotnet restore EarthTool.sln

    - name: Build library
      run: dotnet build ${{ matrix.library.project }}/${{ matrix.library.project }}.csproj --configuration Release --no-restore

    - name: Run tests
      if: matrix.library.test != ''
      run: |
        dotnet test ${{ matrix.library.test }}/${{ matrix.library.test }}.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=${{ matrix.library.name }}-test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults/${{ matrix.library.name }}
      continue-on-error: false

    - name: Test Report
      if: matrix.library.test != '' && (success() || failure())
      uses: dorny/test-reporter@v1
      with:
        name: ${{ matrix.library.name }} Test Results
        path: 'TestResults/${{ matrix.library.name }}/**/*.trx'
        reporter: dotnet-trx
        fail-on-error: false

    - name: Upload coverage
      if: matrix.library.test != ''
      uses: actions/upload-artifact@v4
      with:
        name: coverage-${{ matrix.library.name }}
        path: TestResults/${{ matrix.library.name }}/*/coverage.cobertura.xml
        retention-days: 30

  pack-libraries:
    name: Pack NuGet Packages
    needs: test-libraries
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup .NET Environment
      uses: ./.github/actions/setup-dotnet-env

    - name: Restore dependencies
      run: dotnet restore EarthTool.sln

    - name: Pack libraries
      run: |
        dotnet pack EarthTool.Common/EarthTool.Common.csproj -c Release -o ./packages --no-restore
        dotnet pack EarthTool.WD/EarthTool.WD.csproj -c Release -o ./packages --no-restore
        dotnet pack EarthTool.MSH/EarthTool.MSH.csproj -c Release -o ./packages --no-restore
        dotnet pack EarthTool.DAE/EarthTool.DAE.csproj -c Release -o ./packages --no-restore
        dotnet pack EarthTool.PAR/EarthTool.PAR.csproj -c Release -o ./packages --no-restore
        dotnet pack EarthTool.TEX/EarthTool.TEX.csproj -c Release -o ./packages --no-restore

    - name: Upload NuGet packages
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: packages/*.nupkg
        retention-days: 90

  coverage-report:
    name: Generate Coverage Report
    needs: test-libraries
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download all coverage artifacts
      uses: actions/download-artifact@v4
      with:
        path: coverage-artifacts

    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool || dotnet tool update -g dotnet-reportgenerator-globaltool

    - name: Generate coverage report
      run: |
        reportgenerator \
          -reports:"coverage-artifacts/**/coverage.cobertura.xml" \
          -targetdir:"coverage-report" \
          -reporttypes:"Html;TextSummary;Badges" \
          -title:"EarthTool Libraries Coverage"

    - name: Display coverage summary
      run: cat coverage-report/Summary.txt

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage-report/
        retention-days: 90
