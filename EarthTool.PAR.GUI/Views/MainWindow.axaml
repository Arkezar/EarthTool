<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:EarthTool.PAR.GUI.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
        x:Class="EarthTool.PAR.GUI.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="EarthTool.PAR.GUI">

    <Design.DataContext>
        <!-- This only sets the DataContext for the previewer in an IDE,
             to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <DockPanel>
    <!-- Menu Bar -->
    <Menu DockPanel.Dock="Top">
      <MenuItem Header="_File">
        <MenuItem Header="_New PAR File" Command="{Binding NewFileCommand}" HotKey="Ctrl+N" />
        <MenuItem Header="_Open PAR File..." Command="{Binding OpenFileCommand}" HotKey="Ctrl+O" />
        <Separator />
        <MenuItem Header="_Save" Command="{Binding SaveFileCommand}" HotKey="Ctrl+S" />
        <MenuItem Header="Save _As..." Command="{Binding SaveAsCommand}" HotKey="Ctrl+Shift+S" />
        <Separator />
        <MenuItem Header="_Close" Command="{Binding CloseFileCommand}" />
      </MenuItem>

      <MenuItem Header="_Edit">
        <MenuItem Header="_Undo" Command="{Binding UndoCommand}" HotKey="Ctrl+Z" />
        <MenuItem Header="_Redo" Command="{Binding RedoCommand}" HotKey="Ctrl+Y" />
        <Separator />
        <MenuItem Header="_Add Entity..." Command="{Binding AddEntityCommand}" HotKey="Ctrl+A" />
        <MenuItem Header="_Clone Entity" Command="{Binding CloneEntityCommand}" HotKey="Ctrl+D" />
        <MenuItem Header="_Delete Entity" Command="{Binding DeleteEntityCommand}" HotKey="Delete" />
        <Separator />
        <MenuItem Header="C_opy" Command="{Binding CopyEntityCommand}" HotKey="Ctrl+C" />
        <MenuItem Header="_Paste" Command="{Binding PasteEntityCommand}" HotKey="Ctrl+V" />
      </MenuItem>

      <MenuItem Header="_Help">
        <MenuItem Header="_About PAR Editor" />
      </MenuItem>
    </Menu>

    <!-- Toolbar -->
    <Border DockPanel.Dock="Top" 
            BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
            BorderThickness="0,0,0,1" 
            Padding="8,4">
      <StackPanel Orientation="Horizontal" Spacing="8">
        <Button Command="{Binding NewFileCommand}" ToolTip.Tip="New PAR File (Ctrl+N)">
          <TextBlock Text="ðŸ“„" FontSize="{StaticResource FontSize.Icon}" />
        </Button>
        <Button Command="{Binding OpenFileCommand}" ToolTip.Tip="Open PAR File (Ctrl+O)">
          <TextBlock Text="ðŸ“‚" FontSize="{StaticResource FontSize.Icon}" />
        </Button>
        <Button Command="{Binding SaveFileCommand}" ToolTip.Tip="Save (Ctrl+S)">
          <TextBlock Text="ðŸ’¾" FontSize="{StaticResource FontSize.Icon}" />
        </Button>

        <Separator Width="1" Height="24" />

        <Button Command="{Binding UndoCommand}" ToolTip.Tip="Undo (Ctrl+Z)">
          <TextBlock Text="â†¶" FontSize="{StaticResource FontSize.Icon}" />
        </Button>
        <Button Command="{Binding RedoCommand}" ToolTip.Tip="Redo (Ctrl+Y)">
          <TextBlock Text="â†·" FontSize="{StaticResource FontSize.Icon}" />
        </Button>

        <Separator Width="1" Height="24" />

        <Button Command="{Binding AddEntityCommand}" ToolTip.Tip="Add Entity (Ctrl+A)">
          <TextBlock Text="âž•" FontSize="{StaticResource FontSize.Icon}" />
        </Button>
        <Button Command="{Binding CloneEntityCommand}" ToolTip.Tip="Clone Entity (Ctrl+D)">
          <TextBlock Text="ðŸ“‹" FontSize="{StaticResource FontSize.Icon}" />
        </Button>
        <Button Command="{Binding DeleteEntityCommand}" ToolTip.Tip="Delete Entity (Delete)">
          <TextBlock Text="ðŸ—‘ï¸" FontSize="{StaticResource FontSize.Icon}" />
        </Button>
      </StackPanel>
    </Border>

    <!-- Status Bar -->
    <Border DockPanel.Dock="Bottom" 
            Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
            BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
            BorderThickness="0,1,0,0"
            Padding="8,4">
      <Grid ColumnDefinitions="*,Auto">
        <TextBlock Grid.Column="0" 
                   Text="{Binding StatusMessage}" 
                   VerticalAlignment="Center" />
        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="16">
          <TextBlock VerticalAlignment="Center"
                     IsVisible="{Binding HasUnsavedChanges}">
            <Run Text="â—" Foreground="Orange" />
            <Run Text="Modified" />
          </TextBlock>
        </StackPanel>
      </Grid>
    </Border>

    <!-- Main Content Area -->
    <Grid ColumnDefinitions="350,4,*">

      <!-- Left Panel: Entity Tree -->
      <Border Grid.Column="0" 
              BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
              BorderThickness="0,0,1,0"
              Padding="8">
        <DockPanel>
          <TextBlock DockPanel.Dock="Top" 
                     Text="Entity Groups" 
                     FontSize="{StaticResource FontSize.SectionHeader}" 
                     FontWeight="Bold"
                     Margin="0,0,0,8" />
          
          <TextBox DockPanel.Dock="Top"
                   Watermark="Search entities..."
                   Text="{Binding SearchText}"
                   Margin="0,0,0,8" />

          <ScrollViewer HorizontalScrollBarVisibility="Auto"
                        VerticalScrollBarVisibility="Auto">
            <TreeView ItemsSource="{Binding RootNodes}"
                      SelectedItem="{Binding SelectedNode}"
                      AutoScrollToSelectedItem="True">
              
              <TreeView.Styles>
                <Style Selector="TreeViewItem" x:DataType="vm:TreeNodeViewModelBase">
                  <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                </Style>
              </TreeView.Styles>
              
              <TreeView.DataTemplates>
                
                <!-- Entity Groups Root Template -->
                <TreeDataTemplate DataType="vm:EntityGroupsRootNodeViewModel" 
                                ItemsSource="{Binding FilteredChildren}">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding DisplayName}" 
                               FontWeight="Bold"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding DisplayName}" />
                  </StackPanel>
                </TreeDataTemplate>
                
                <!-- Research Root Template -->
                <TreeDataTemplate DataType="vm:ResearchRootNodeViewModel" 
                                ItemsSource="{Binding FilteredChildren}">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding DisplayName}" 
                               FontWeight="Bold"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding DisplayName}" />
                  </StackPanel>
                </TreeDataTemplate>
                
                <!-- Faction Node Template (for Entity Groups) -->
                <TreeDataTemplate DataType="vm:FactionNodeViewModel" 
                                ItemsSource="{Binding FilteredChildren}">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding DisplayName}"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding DisplayName}" />
                  </StackPanel>
                </TreeDataTemplate>
                
                <!-- GroupType Node Template -->
                <TreeDataTemplate DataType="vm:GroupTypeNodeViewModel" 
                                ItemsSource="{Binding FilteredChildren}">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding DisplayName}"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding DisplayName}" />
                  </StackPanel>
                </TreeDataTemplate>
                
                <!-- EntityGroup Node Template -->
                <TreeDataTemplate DataType="vm:EntityGroupNodeViewModel" 
                                ItemsSource="{Binding FilteredChildren}">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding DisplayName}"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding DisplayName}" />
                  </StackPanel>
                </TreeDataTemplate>
                
                <!-- Entity (Leaf) Template -->
                <DataTemplate DataType="vm:EntityListItemViewModel">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding Name}"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding ToolTip}" />
                    <TextBlock Text="â—" 
                              Foreground="Orange" 
                              FontSize="{StaticResource FontSize.Badge}"
                              IsVisible="{Binding IsDirty}" />
                  </StackPanel>
                </DataTemplate>
                
                <!-- Faction Research Node Template -->
                <TreeDataTemplate DataType="vm:FactionResearchNodeViewModel" 
                                ItemsSource="{Binding FilteredChildren}">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding DisplayName}"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding DisplayName}" />
                  </StackPanel>
                </TreeDataTemplate>
                
                <!-- Research Type Node Template -->
                <TreeDataTemplate DataType="vm:ResearchTypeNodeViewModel" 
                                ItemsSource="{Binding FilteredChildren}">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding DisplayName}"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding DisplayName}" />
                  </StackPanel>
                </TreeDataTemplate>
                
                <!-- Research (Leaf) Template -->
                <DataTemplate DataType="vm:ResearchViewModel">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="{StaticResource FontSize.Icon}" />
                    <TextBlock Text="{Binding Name}"
                               TextTrimming="CharacterEllipsis"
                               ToolTip.Tip="{Binding Name}" />
                  </StackPanel>
                </DataTemplate>
                
              </TreeView.DataTemplates>
            </TreeView>
          </ScrollViewer>
        </DockPanel>
      </Border>

      <GridSplitter Grid.Column="1" 
                    ResizeDirection="Columns" 
                    Background="Transparent" />

      <!-- Right Panel: Entity Details -->
      <Border Grid.Column="2" Padding="8">
        <DockPanel>
          <!-- Sticky Header with Actions -->
          <Border DockPanel.Dock="Top"
                  Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                  BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
                  BorderThickness="0,0,0,1"
                  Padding="0,0,0,8"
                  Margin="-8,-8,-8,8">
            <Grid ColumnDefinitions="*,Auto" Margin="8,8,8,0">
              <TextBlock Grid.Column="0"
                         Text="Entity Details" 
                         FontSize="{StaticResource FontSize.SectionHeader}" 
                         FontWeight="Bold"
                         VerticalAlignment="Center" />
              
              <StackPanel Grid.Column="1"
                         Orientation="Horizontal"
                         Spacing="8"
                         IsVisible="{Binding !!SelectedEntity}">
                <Button Content="âŸ² Revert"
                        Command="{Binding EntityDetailsViewModel.RevertChangesCommand}"
                        ToolTip.Tip="Revert all changes"
                        IsVisible="{Binding EntityDetailsViewModel.CurrentEntity.IsDirty}" />
                <Button Content="âœ“ Validate"
                        Command="{Binding EntityDetailsViewModel.ValidateCommand}"
                        ToolTip.Tip="Validate entity properties" />
              </StackPanel>
            </Grid>
          </Border>

          <TextBlock DockPanel.Dock="Top"
                     Text="Select an entity to view details"
                     Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                     Margin="0,0,0,8"
                     IsVisible="{Binding !SelectedEntity}" />

          <ScrollViewer IsVisible="{Binding !!SelectedEntity}">
            <StackPanel Spacing="12" DataContext="{Binding EntityDetailsViewModel}">
      <!-- Entity Header -->
      <Border BorderBrush="{DynamicResource SystemControlForegroundBaseLowBrush}"
              BorderThickness="0,0,0,1"
              Padding="0,0,0,8">
        <StackPanel Spacing="4">
          <!-- Entity Header -->
          <StackPanel Spacing="4" IsVisible="{Binding !!CurrentEntity}">
            <TextBox Text="{Binding EntityName}" 
                     FontSize="{StaticResource FontSize.EntityName}" 
                     FontWeight="Bold"
                     Watermark="Entity Name" />
            <TextBlock>
              <Run Text="Type: " />
              <Run Text="{Binding EntityType}" FontWeight="Bold" />
            </TextBlock>
            <TextBlock>
              <Run Text="Class: " />
              <Run Text="{Binding ClassType}" />
            </TextBlock>
          </StackPanel>
          
          <!-- Research Header -->
          <StackPanel Spacing="4" IsVisible="{Binding !!CurrentResearch}">
            <TextBox Text="{Binding EntityName}" 
                     FontSize="{StaticResource FontSize.EntityName}" 
                     FontWeight="Bold"
                     Watermark="Research Name" />
            <TextBlock>
              <Run Text="Type: " />
              <Run Text="{Binding EntityType}" FontWeight="Bold" />
            </TextBlock>
            <TextBlock>
              <Run Text="Faction: " />
              <Run Text="{Binding ClassType}" FontWeight="Bold" />
            </TextBlock>
          </StackPanel>
        </StackPanel>
      </Border>

              <!-- Validation Summary (collapsible) -->
              <Expander IsVisible="{Binding HasValidationIssues}"
                        IsExpanded="{Binding HasErrors}"
                        Margin="0,0,0,8">
                <Expander.Header>
                  <Grid ColumnDefinitions="Auto,*,Auto">
                    <TextBlock Grid.Column="0"
                               Text="âš "
                               FontSize="{StaticResource FontSize.ValidationSummary}"
                               Margin="0,0,8,0"
                               VerticalAlignment="Center" />
                    <TextBlock Grid.Column="1"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center">
                      <Run Text="{Binding ValidationErrors.Count}" />
                      <Run Text=" validation issue(s)" />
                    </TextBlock>
                    <TextBlock Grid.Column="2"
                               Text="Click to expand"
                               FontSize="{StaticResource FontSize.Helper}"
                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                               VerticalAlignment="Center"
                               IsVisible="{Binding !$parent[Expander].IsExpanded}" />
                  </Grid>
                </Expander.Header>
                
                <ItemsControl ItemsSource="{Binding ValidationErrors}" Margin="24,4,0,0">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border Background="{Binding Severity, Converter={StaticResource SeverityToBrushConverter}}"
                              CornerRadius="3"
                              Padding="6,4"
                              Margin="0,2">
                        <Grid ColumnDefinitions="Auto,Auto,*">
                          <TextBlock Grid.Column="0"
                                     Text="{Binding Severity, Converter={StaticResource SeverityToIconConverter}}"
                                     Foreground="White"
                                     FontWeight="Bold"
                                     FontSize="{StaticResource FontSize.ValidationIcon}"
                                     Margin="0,0,6,0"
                                     VerticalAlignment="Center" />
                          <TextBlock Grid.Column="1"
                                     Text="{Binding PropertyName}"
                                     Foreground="White"
                                     FontWeight="SemiBold"
                                     FontSize="{StaticResource FontSize.Helper}"
                                     Margin="0,0,6,0"
                                     VerticalAlignment="Center" />
                          <TextBlock Grid.Column="2"
                                     Text="{Binding ErrorMessage}"
                                     Foreground="White"
                                     FontSize="{StaticResource FontSize.Helper}"
                                     TextWrapping="Wrap"
                                     VerticalAlignment="Center" />
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </Expander>

              <!-- Property Groups -->
              <ItemsControl ItemsSource="{Binding PropertyGroups}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Expander IsExpanded="{Binding IsExpanded}"
                              Margin="0,4"
                              HorizontalAlignment="Stretch">
                      <Expander.Header>
                        <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto">
                          <!-- Group Icon -->
                          <Border Grid.Column="0"
                                  Width="28" Height="28"
                                  Background="{DynamicResource SystemControlBackgroundAccentBrush}"
                                  CornerRadius="6"
                                  Margin="0,0,10,0">
                            <TextBlock Text="{Binding GroupName, Converter={StaticResource GroupNameToIconConverter}}"
                                       FontSize="{StaticResource FontSize.GroupIcon}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center" />
                          </Border>
                          
                          <!-- Group Name -->
                          <TextBlock Grid.Column="1"
                                     Text="{Binding GroupName}"
                                     FontWeight="SemiBold"
                                     FontSize="{StaticResource FontSize.GroupName}"
                                     VerticalAlignment="Center"
                                     Margin="0,0,8,0" />
                          
                          <!-- Spacer -->
                          <Border Grid.Column="2" />
                          
                          <!-- Property Count Badge -->
                          <Border Grid.Column="3"
                                  Background="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                                  CornerRadius="10"
                                  Padding="8,2"
                                  Margin="0,0,6,0">
                            <TextBlock Text="{Binding PropertyCount}"
                                       FontSize="{StaticResource FontSize.GroupBadge}"
                                       FontWeight="Medium"
                                       Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}" />
                          </Border>
                          
                          <!-- Error Indicator -->
                          <Border Grid.Column="4"
                                  Background="#FFDC3545"
                                  CornerRadius="10"
                                  Padding="6,2"
                                  IsVisible="{Binding HasErrors}">
                            <StackPanel Orientation="Horizontal" Spacing="4">
                              <TextBlock Text="âš "
                                         Foreground="White"
                                         FontSize="{StaticResource FontSize.GroupBadge}"
                                         VerticalAlignment="Center" />
                              <TextBlock Text="{Binding ErrorCount}"
                                         Foreground="White"
                                         FontSize="{StaticResource FontSize.GroupBadge}"
                                         FontWeight="Medium"
                                         VerticalAlignment="Center" />
                            </StackPanel>
                          </Border>
                        </Grid>
                      </Expander.Header>
                      <StackPanel Spacing="4" Margin="8">
                        <ItemsControl ItemsSource="{Binding Properties}">
                          <ItemsControl.ItemTemplate>
                            <DataTemplate>
                              <Grid ColumnDefinitions="Auto,*,Auto" Margin="0,6">
                                <!-- Label Column -->
                                <TextBlock Grid.Column="0"
                                           Text="{Binding DisplayName}"
                                           FontWeight="Medium"
                                           FontSize="{StaticResource FontSize.PropertyLabel}"
                                           Margin="0,0,16,0"
                                           VerticalAlignment="Center"
                                           Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}" />
                                
                                <!-- Value Column with Background -->
                                <Border Grid.Column="1"
                                        Background="{DynamicResource SystemControlBackgroundAltMediumLowBrush}"
                                        CornerRadius="3"
                                        Padding="8,4">
                                  <StackPanel Spacing="2">
                                    <!-- Content Control with DataTemplates for different editor types -->
                                    <ContentControl Content="{Binding}">
                                      <ContentControl.DataTemplates>
                                        <!-- IntPropertyEditor Template -->
                                        <DataTemplate DataType="vm:IntPropertyEditorViewModel">
                                          <NumericUpDown Value="{Binding IntValue}"
                                                         Minimum="{Binding MinValue}"
                                                         Maximum="{Binding MaxValue}"
                                                         Increment="{Binding Step}"
                                                         IsEnabled="{Binding !IsReadOnly}"
                                                         FontSize="{StaticResource FontSize.PropertyValue}"
                                                         HorizontalAlignment="Stretch" />
                                        </DataTemplate>
                                        
                                        <!-- StringPropertyEditor Template -->
                                        <DataTemplate DataType="vm:StringPropertyEditorViewModel">
                                          <TextBox Text="{Binding StringValue}"
                                                   MaxLength="{Binding MaxLength}"
                                                   Watermark="{Binding PlaceholderText}"
                                                   IsEnabled="{Binding !IsReadOnly}"
                                                   AcceptsReturn="{Binding IsMultiline}"
                                                   TextWrapping="{Binding IsMultiline}"
                                                   FontSize="{StaticResource FontSize.PropertyValue}"
                                                   HorizontalAlignment="Stretch" />
                                        </DataTemplate>
                                        
                                        <!-- EnumPropertyEditor Template -->
                                        <DataTemplate DataType="vm:EnumPropertyEditorViewModel">
                                          <ComboBox ItemsSource="{Binding AvailableValues}"
                                                    SelectedItem="{Binding SelectedValue}"
                                                    IsEnabled="{Binding !IsReadOnly}"
                                                    FontSize="{StaticResource FontSize.PropertyValue}"
                                                    HorizontalAlignment="Stretch">
                                            <ComboBox.ItemTemplate>
                                              <DataTemplate>
                                                <TextBlock Text="{Binding DisplayName}" />
                                              </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                          </ComboBox>
                                        </DataTemplate>
                                        
                                        <!-- FlagsPropertyEditor Template -->
                                        <DataTemplate DataType="vm:FlagsPropertyEditorViewModel">
                                          <ItemsControl ItemsSource="{Binding AvailableFlags}"
                                                        IsEnabled="{Binding !IsReadOnly}">
                                            <ItemsControl.ItemsPanel>
                                              <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal" />
                                              </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                              <DataTemplate>
                                                <CheckBox Content="{Binding DisplayName}"
                                                          IsChecked="{Binding IsSelected}"
                                                          Margin="0,0,12,4"
                                                          FontSize="{StaticResource FontSize.PropertyValue}">
                                                  <ToolTip.Tip>
                                                    <TextBlock>
                                                      <Run Text="{Binding Description}" FontWeight="Bold" />
                                                      <LineBreak />
                                                      <Run Text="Value: " />
                                                      <Run Text="{Binding NumericValue}" />
                                                    </TextBlock>
                                                  </ToolTip.Tip>
                                                </CheckBox>
                                              </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                          </ItemsControl>
                                        </DataTemplate>
                                        
                                        <!-- IntCollectionPropertyEditor Template -->
                                        <DataTemplate DataType="vm:IntCollectionPropertyEditorViewModel">
                                          <TextBox Text="{Binding StringValue}"
                                                   Watermark="Comma-separated integers (e.g., 1, 2, 3)"
                                                   IsEnabled="{Binding !IsReadOnly}"
                                                   FontSize="{StaticResource FontSize.PropertyValue}"
                                                   HorizontalAlignment="Stretch">
                                            <ToolTip.Tip>
                                              <TextBlock Text="Enter comma-separated integers (e.g., 1, 2, 3)" />
                                            </ToolTip.Tip>
                                          </TextBox>
                                        </DataTemplate>
                                        
                                        <!-- Fallback Template (for unknown types) -->
                                        <DataTemplate DataType="vm:PropertyEditorViewModel">
                                          <TextBlock Text="{Binding Value}"
                                                     TextWrapping="Wrap"
                                                     FontSize="{StaticResource FontSize.PropertyValue}"
                                                     Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                                     FontStyle="Italic" />
                                        </DataTemplate>
                                      </ContentControl.DataTemplates>
                                    </ContentControl>
                                    
                                    <!-- Validation Message with Severity Indicator -->
                                    <Border IsVisible="{Binding !IsValid}"
                                            Background="{Binding ValidationSeverity, Converter={StaticResource SeverityToBrushConverter}}"
                                            CornerRadius="3"
                                            Padding="6,3"
                                            Margin="0,2,0,0">
                                      <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="{Binding ValidationSeverity, Converter={StaticResource SeverityToIconConverter}}"
                                                   Foreground="White"
                                                   FontWeight="Bold"
                                                   FontSize="{StaticResource FontSize.ValidationIcon}"
                                                   VerticalAlignment="Center" />
                                        <TextBlock Text="{Binding ErrorMessage}"
                                                   Foreground="White"
                                                   FontSize="{StaticResource FontSize.ValidationError}"
                                                   FontWeight="Medium"
                                                   TextWrapping="Wrap" />
                                      </StackPanel>
                                    </Border>
                                  </StackPanel>
                                </Border>
                                
                                <!-- Action Buttons Column -->
                                <StackPanel Grid.Column="2"
                                           Orientation="Horizontal"
                                           Spacing="4"
                                           Margin="8,0,0,0"
                                           VerticalAlignment="Center">
                                  <!-- Copy Button -->
                                  <Button Command="{Binding CopyValueCommand}"
                                          ToolTip.Tip="Copy value to clipboard"
                                          Width="28"
                                          Height="28"
                                          Padding="0"
                                          Background="Transparent"
                                          BorderThickness="0">
                                    <TextBlock Text="ðŸ“‹"
                                               FontSize="14"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center" />
                                  </Button>
                                  
                                  <!-- Navigate to Reference Button -->
                                  <Button Command="{Binding NavigateToReferenceCommand}"
                                          ToolTip.Tip="Navigate to referenced entity"
                                          Width="28"
                                          Height="28"
                                          Padding="0"
                                          Background="Transparent"
                                          BorderThickness="0"
                                          IsVisible="{Binding IsEntityReference}">
                                    <TextBlock Text="â†’"
                                               FontSize="16"
                                               FontWeight="Bold"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center" />
                                  </Button>
                                </StackPanel>
                              </Grid>
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                      </StackPanel>
                    </Expander>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>


            </StackPanel>
          </ScrollViewer>
        </DockPanel>
      </Border>
    </Grid>
  </DockPanel>
</Window>
